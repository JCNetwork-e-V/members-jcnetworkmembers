<!DOCTYPE html>
<html lang="de"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">

<div th:fragment="organizational-chart" class="container-fluid">
    <div class="row">

        <div class="col-md-9">
            <!-- main card -->
            <div class="card card-primary card-outline">
                <div class="card-header">
                    <h3 class="card-title">Organigramm</h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm">
                            <div class="btn-group">
                                <button type="button" class="btn btn-default">
                                    <i class="fas fa-file-image"></i>
                                </button>
                                <button type="button" class="btn btn-default">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.card-header -->
                <div class="card-body p-0">
                    <!-- organizational chart -->
                    <div id="chart-container" style="text-align: center; min-height: 300px"></div>

                </div>
                <!-- /.card-body -->
                <div class="card-footer p-0">

                </div>
            </div>
            <!-- /.chart card -->
        </div>

        <div class="col-md-3">

            <!-- Input addon -->
            <div class="card">

                <div class="card-header">
                    <h3 class="card-title">Struktur Bearbeiten</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>

                <div class="card-body">

                    <p>Gewähltes Element</p>
                    <div class="input-group mb-3">
                        <!-- /btn-group -->
                        <input type="text" id="selected-node" class="form-control" disabled style="background-color: white">
                        <div class="input-group-append">
                            <button type="button" id="btn-delete-nodes" class="btn btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <!-- /input-group -->

                    <p>Element hinzufügen</p>
                    <div class="input-group mb-3">
                        <!-- /btn-group -->
                        <input type="text" id="new-node" class="form-control">
                        <div class="input-group-append">
                            <button type="button" id="btn-add-nodes" class="btn btn-jcnetwork">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <!-- /input-group -->

                    <div class="row">
                        <div class="col-8">
                            <button class="btn btn-jcnetwork" id="btn-save" style="width: 100%">Speichern</button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-jcnetwork" id="btn-reset" style="width: 100%">
                                <i class="fas fa-redo-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
        </div>
    </div>
</div>

<th:block th:fragment="organizational-chart-scripts">
    <script type="text/javascript" src="/plugins/org-chart/js/jquery.orgchart.js"></script>
    <script>
        $(function() {

            var datasource = "";
            var oc;

            var getId = function() {
                return (new Date().getTime()) * 1000 + Math.floor(Math.random() * 1001);
            };

            getChart();

            // Get organizational chart
            function getChart() {
                $.ajax({
                    'url': "/api/organizationalStructure/" + window.location.pathname.split('/')[1],
                    'async': false,
                    'method': "GET",
                    'contentType': 'application/json',
                    'dataType': "json",
                    'success': function (response) {

                        oc = $('#chart-container').orgchart({
                            'data': response,
                            'nodeId': 'name',
                            'nodeContent': 'title',
                            'pan': true,
                            'zoom': true
                        });
                    }
                });
            }

            oc.$chartContainer.on('touchmove', function (event) {
                event.preventDefault();
            });


            oc.$chartContainer.on('click', '.node', function () {
                var $this = $(this);
                $('#selected-node').val($this.find('.title').text()).data('node', $this);
            });

            oc.$chartContainer.on('click', '.orgchart', function (event) {
                if (!$(event.target).closest('.node').length) {
                    $('#selected-node').val('');
                }
            });

            $('input[name="chart-state"]').on('click', function() {
                $('.orgchart').toggleClass('edit-state', this.value !== 'view');
                $('#edit-panel').toggleClass('edit-state', this.value === 'view');
                if ($(this).val() === 'edit') {
                    $('.orgchart').find('.hidden').removeClass('hidden')
                        .end().find('.hierarchy').removeClass('isCollapsedDescendant isChildrenCollapsed isSiblingsCollapsed isCollapsedSibling')
                        .find('.node').removeClass('slide-up slide-down slide-right slide-left');
                } else {
                    $('#btn-reset').trigger('click');
                }
            });

            $('#btn-add-nodes').on('click', function() {
                var $chartContainer = $('#chart-container');
                var newNodeInputField = $('#new-node');
                var nodeVals = [];
                var validVal = newNodeInputField.val().trim();
                if (validVal.length) {
                    nodeVals.push(validVal);
                }
                var $node = $('#selected-node').data('node');
                if (!nodeVals.length) {
                    alert('Please input value for new node');
                    return;
                }
                if (!$node) {
                    alert('Please select one node in orgchart');
                    return;
                }
                newNodeInputField.val('');
                if (!$node.siblings('.nodes').length) {
                    var rel = nodeVals.length > 1 ? '110' : '100';
                    oc.addChildren($node, nodeVals.map(function (item) {
                        return { 'name': item, 'relationship': rel, 'id': getId() };
                    }));
                } else {
                    oc.addSiblings($node.siblings('.nodes').find('.node:first'), nodeVals.map(function (item) {
                        return { 'name': item, 'relationship': '110', 'id': getId() };
                    }));
                }
            });

            $('#btn-delete-nodes').on('click', function() {
                var $node = $('#selected-node').data('node');
                if (!$node) {
                    alert('Please select one node in orgchart');
                    return;
                } else if ($node[0] === $('.orgchart').find('.node:first')[0]) {
                    alert('Der Vorstand kann nicht gelöscht werden.')
                    return;
                }
                oc.removeNodes($node);
                $('#selected-node').val('').data('node', null);
            });

            $('#chart-container').on('click', function(e) {
                if (e.target.className !== 'title' && e.target.className !== 'content') {
                    $('.orgchart').find('.focused').removeClass('focused');
                    $('#selected-node').val('');
                    $('#new-nodelist').find('input:first').val('').parent().siblings().remove();
                    $('#node-type-panel').find('input').prop('checked', false);
                }
            });

            $('#btn-save').on('click', function() {
                if (!$('pre').length) {
                    var hierarchy = oc.getHierarchy(true);
                    $.ajax({
                        'url': "/api/organizationalStructure/" + window.location.pathname.split('/')[1] + "/update",
                        'method': "PUT",
                        'contentType': 'application/json',
                        'dataType': "json",
                        'data': JSON.stringify(hierarchy)
                    });
                }
            });

            $('#btn-reset').on('click', function() {
                $('#chart-container').empty();
                getChart();
            })

        });
    </script>
</th:block>